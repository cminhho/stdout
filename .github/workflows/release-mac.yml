# Release macOS: push tag v* (e.g. v1.0.0). package.json version must match tag. generate_release_notes: false (GITHUB_TOKEN 403).
name: Release macOS

on:
  push:
    tags: ['v*']

env:
  ELECTRON_CACHE: ${{ github.workspace }}/.cache/electron
  ELECTRON_BUILDER_CACHE: ${{ github.workspace }}/.cache/electron-builder

jobs:
  release-mac:
    runs-on: macos-latest
    timeout-minutes: 45
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Version check
        id: ver
        run: |
          tag="${GITHUB_REF#refs/tags/v}"
          pkg=$(sed -n 's/.*"version" *: *"\([^"]*\)".*/\1/p' package.json)
          [ "$tag" = "$pkg" ] || { echo "::error::Tag v$tag != package.json $pkg"; exit 1; }
          echo "VERSION=$tag" >> $GITHUB_OUTPUT

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/.cache/electron
            ${{ github.workspace }}/.cache/electron-builder
          key: macos-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: macos-${{ runner.os }}-

      - run: npm ci --legacy-peer-deps

      - name: Build
        run: npm run electron:build:mac:ci
        env:
          ELECTRON_BUILD: 1
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate release notes
        id: notes
        run: |
          ver="${{ steps.ver.outputs.VERSION }}"
          prev=$(git tag -l 'v*' --sort=-version:refname | sed -n '2p')
          if [ -z "$prev" ]; then
            echo "## Release v${ver}" > release-body.md
            echo "" >> release-body.md
            echo "First release." >> release-body.md
          else
            echo "## What's changed" >> release-body.md
            echo "" >> release-body.md
            git log "${prev}..HEAD" --pretty=format:'- %s' >> release-body.md || true
          fi

      - uses: softprops/action-gh-release@v2
        with:
          files: |
            release/stdout-${{ steps.ver.outputs.VERSION }}-mac.zip
            release/stdout-${{ steps.ver.outputs.VERSION }}-arm64-mac.zip
          body_path: release-body.md
          generate_release_notes: false
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
